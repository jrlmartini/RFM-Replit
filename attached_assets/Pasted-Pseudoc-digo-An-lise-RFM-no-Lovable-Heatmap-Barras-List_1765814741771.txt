Pseudoc√≥digo ‚Äì An√°lise RFM no Lovable (Heatmap, Barras, Listas)
Objetivo: a partir de uma base de vendas (Excel), calcular RFM por cliente, classificar em categorias e gerar (a) heatmap 5√ó5, (b) gr√°fico de barras por categoria e (c) listas de clientes por categoria com seus scores.
 
Entradas esperadas do arquivo
‚Ä¢	Cliente (Nome Fantasia) (texto)
‚Ä¢	Data de Emiss√£o (completa) (data)
‚Ä¢	Total da Nota Fiscal (n√∫mero)
‚Ä¢	Tags (texto; substrings como "Autarquia" e/ou "Privado")
Par√¢metros de UI (Lovable)
‚Ä¢	Arquivo (upload Excel .xlsx)
‚Ä¢	PrazoMeses (slider inteiro 1‚Äì36; padr√£o: 12)
‚Ä¢	SegmentosSelecionados (multiselect: {Autarquia, Privado}; padr√£o: ambos)
‚Ä¢	BotaoIniciar (a√ß√£o)
 
Fluxo principal (onClick BotaoIniciar)
quando BotaoIniciar for clicado:
    se Arquivo n√£o enviado:
        mostrar "‚ö†Ô∏è Por favor, envie um arquivo Excel."
        parar

    DF ‚Üê ler_planilha(Arquivo)
    se DF estiver vazio:
        mostrar "‚ö†Ô∏è Arquivo vazio."
        parar

    // 1) Padroniza√ß√£o de tipos
    DF["Data de Emiss√£o (completa)"] ‚Üê para_data(DF[...])
    DF["Total da Nota Fiscal"] ‚Üê para_numero(DF[...], coer√ß√£o_nulos=true)
    DF["Tags"] ‚Üê para_texto(DF["Tags"])

    // 2) Filtro por Segmento (Tags cont√©m qualquer selecionado)
    DF ‚Üê DF onde existe seg ‚àà SegmentosSelecionados tal que seg ‚àà DF["Tags"]

    // 3) Seleciona colunas essenciais e remove nulos
    DF ‚Üê selecionar [
        "Cliente (Nome Fantasia)",
        "Data de Emiss√£o (completa)",
        "Total da Nota Fiscal"
    ]
    DF ‚Üê remover_linhas_com_nulos(DF)

    // 4) Filtro temporal (janela de PrazoMeses)
    LimiteData ‚Üê hoje() - meses(PrazoMeses)
    DF_Filtrado ‚Üê DF onde "Data de Emiss√£o (completa)" ‚â• LimiteData
    se DF_Filtrado vazio:
        mostrar "‚ö†Ô∏è Sem movimenta√ß√£o no per√≠odo selecionado."
        parar

    // 5) Constru√ß√£o de R, F, M
    LatestDate ‚Üê max(DF_Filtrado["Data de Emiss√£o (completa)"])

    RecencyPorCliente ‚Üê para cada Cliente C:
        dias = (LatestDate - max(data de C)).em_dias()
        retornar (C, dias)

    FrequencyPorCliente ‚Üê contagem de linhas por Cliente em DF_Filtrado
    MonetaryPorCliente ‚Üê soma de "Total da Nota Fiscal" por Cliente

    RFM ‚Üê juntar por Cliente:
        colunas = [Cliente, Recency, Frequency, Monetary]

    // 6) Escoragem em quintis (1‚Üípior, 5‚Üímelhor)
    Score_R ‚Üê quintil(Recency, labels=[5,4,3,2,1])      // menor rec√™ncia = melhor
    Score_F ‚Üê quintil(rank(Frequency), labels=[1,2,3,4,5])
    Score_M ‚Üê quintil(rank(Monetary),  labels=[1,2,3,4,5])
    Score_FM ‚Üê arredondar((Score_F + Score_M) / 2)

    anexar a RFM: Score_R, Score_F, Score_M, Score_FM

    // 7) Classifica√ß√£o por regras
    fun√ß√£o Classificar(score_r, score_fm):
        se score_r==5 e score_fm==5: retornar "Campe√µes"
        sen√£o se (score_r==5 e score_fm==4) ou (score_r==4 e score_fm‚àà{4,5}) ou (score_r==3 e score_fm‚àà{4,5}): retornar "Fiel"
        sen√£o se score_r==3 e score_fm==3: retornar "Atencao"
        sen√£o se score_r==3 e score_fm‚àà{1,2}: retornar "Quase Domententes"
        sen√£o se score_r==4 e score_fm==1: retornar "Promessas"
        sen√£o se score_r==5 e score_fm==1: retornar "Novos Clientes"
        sen√£o se score_r==2 e score_fm==2: retornar "Hibernando"
        sen√£o se score_r‚àà{1,2} e score_fm==5: retornar "Nao Pode Perder"
        sen√£o se score_r‚àà{1,2} e score_fm‚àà{3,4}: retornar "Em Risco"
        sen√£o se (score_r==1 e score_fm‚àà{1,2}) ou (score_r==2 e score_fm==1): retornar "Perdidos"
        sen√£o se score_r‚àà{4,5} e score_fm‚àà{2,3}: retornar "Fiel em Potencial"
        sen√£o: retornar "Sem Categoria"

    RFM["Category"] ‚Üê aplicar Classificar(Score_R, Score_FM)

    // 8) Heatmap 5√ó5 (garantir grade completa)
    ALL ‚Üê [1,2,3,4,5]
    Grade ‚Üê produto_cartesiano(Score_FM‚ààALL, Score_R‚ààALL)

    para cada (fm, r) em Grade:
        CategoriaCel = Classificar(r, fm)
        registrar (fm, r, CategoriaCel)

    Contagens ‚Üê contar RFM por (Score_FM, Score_R)
    HeatmapFull ‚Üê Grade juntar Contagens (left join), nulos Count‚Üí0

    PivotCat   ‚Üê pivot(HeatmapFull, index=Score_FM, columns=Score_R, values=Categoria)
    PivotCount ‚Üê pivot(HeatmapFull, index=Score_FM, columns=Score_R, values=Count)

    CoresCategoria = {
        "Campe√µes":"#264653", "Fiel":"#2a9d8f", "Atencao":"#e76f51",
        "Quase Domententes":"#f4a261", "Promessas":"#e9c46a",
        "Novos Clientes":"#f4d35e", "Hibernando":"#8d99ae",
        "Nao Pode Perder":"#d62828", "Em Risco":"#bc4749",
        "Perdidos":"#6d597a", "Fiel em Potencial":"#ffb703",
        "Sem Categoria":"#e0e0e0"
    }

    IndiceCategoria ‚Üê mapear categorias ‚Üí √≠ndices (ordem das chaves de CoresCategoria)
    MatrizNum ‚Üê aplicar IndiceCategoria sobre PivotCat (fallback: "Sem Categoria")

    Annot[i,j] ‚Üê string "{PivotCount[i,j]}\n{PivotCat[i,j]}"

    plot_heatmap(
        data=MatrizNum,
        cmap=lista(CoresCategoria em ordem de IndiceCategoria),
        anotacoes=Annot,
        titulo="An√°lise RFM - Heatmap de Categorias (Completo)",
        eixo_x="Rec√™ncia (Score_R 1‚Üí5)",
        eixo_y="Frequ√™ncia + Monet√°rio (Score_FM 1‚Üí5)",
        inverter_y=true,
        legenda_por_categoria = contar RFM["Category"] na mesma ordem das cores
    )
    salvar_imagem("rfm_heatmap.png")

    // 9) Barras ‚Äì n¬∫ de clientes por categoria
    CatCounts ‚Üê contar RFM["Category"]
    CatCounts ‚Üê reindexar(CatCounts, chaves(CoresCategoria), faltas‚Üí0)

    plot_barras(
        categorias=CatCounts.index,
        valores=CatCounts.values,
        cores=map(CoresCategoria[cat] para cat em CatCounts.index),
        titulo="Clientes por Categoria RFM",
        eixo_y="N√∫mero de Clientes",
        rotacao_xticks=45
    )
    salvar_imagem("rfm_barras.png")

    // 10) Sa√≠das/Exporta√ß√£o
    escrever_excel("rfm_resultado.xlsx") com abas:
        - "Clientes RFM": RFM com colunas [
            Cliente, Recency, Frequency, Monetary,
            Score_R, Score_F, Score_M, Score_FM, Category
          ]
        - "Resumo Categorias": tabela [Categoria, Qtd Clientes] a partir de CatCounts

    mostrar "üìä Heatmap salvo em rfm_heatmap.png"
    mostrar "üìà Barras salvas em rfm_barras.png"
    mostrar "üìÅ Planilha gerada: rfm_resultado.xlsx"
 
Sa√≠das para visualiza√ß√£o na UI
‚Ä¢	Heatmap 5√ó5 com anota√ß√µes (contagem + nome da categoria em cada c√©lula).
‚Ä¢	Gr√°fico de barras com n¬∫ de clientes por categoria (cores consistentes com o heatmap).
‚Ä¢	Tabela/Listas filtr√°veis por Category, exibindo por cliente: Recency, Frequency, Monetary, Score_R, Score_F, Score_M, Score_FM, Category.
Observa√ß√µes:
‚Ä¢	O c√°lculo de quintis usa rank para F e M antes de particionar, reduzindo empates.
‚Ä¢	O eixo Y do heatmap √© invertido para que Score_FM=5 apare√ßa no topo.
‚Ä¢	As cores de categoria s√£o fixas para manter consist√™ncia visual entre heatmap e barras.

Paleta de cores:
Campe√µes:          #264653
Fiel:              #2a9d8f
Atencao:           #e76f51
Quase Domententes: #f4a261
Promessas:         #e9c46a
Novos Clientes:    #f4d35e
Hibernando:        #8d99ae
Nao Pode Perder:   #d62828
Em Risco:          #bc4749
Perdidos:          #6d597a
Fiel em Potencial: #ffb703
Sem Categoria:     #e0e0e0
